#version: '3.8' # Specify Docker Compose file format version

services:
  backend:
    container_name: finance-tracker-backend
    build:
      context: . # Build context is the current directory (solution root)
      dockerfile: Dockerfile.backend # Path to the backend's Dockerfile
    ports:
      - "5258:5258"
    env_file: ./.env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__DefaultConnection=Host=${DB_HOST};Port=${DB_PORT};Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      #- FrontendUrl=${FRONTEND_URL}
    depends_on:
      - db # Backend service depends on the database service being started
    restart: unless-stopped # Always restart unless explicitly stopped

  frontend:
    container_name: finance-tracker-frontend
    build:
      context: . # Build context is the current directory (solution root)
      dockerfile: Dockerfile.frontend # Path to the frontend's Dockerfile
    ports:
      - "4200:80" # Map host port 4200 to container's port 80 (Nginx default). Access frontend via http://localhost:4200
    #env_file: ./.env
    #environment:
    #  - BACKEND_URL=${BACKEND_INTERNAL_URL}
    depends_on:
      - backend # Frontend service depends on the backend service being started (for API proxying)
    restart: unless-stopped # Always restart unless explicitly stopped

  db:
    container_name: finance-tracker-db
    image: postgres:14-alpine # Use a specific version of PostgreSQL. 'alpine' images are smaller.
    ports:
      - "5432:5432" # Map host port 5432 to container's port 5432. Access DB directly via localhost:5432
    env_file: ./.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      # Persist database data to a named volume on the host, so data isn't lost if container is removed.
      - finance_tracker_db_data:/var/lib/postgresql/data
    restart: unless-stopped # Always restart unless explicitly stopped

# Define the named volumes used by services
volumes:
  finance_tracker_db_data: # Data for the PostgreSQL database